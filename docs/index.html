<!DOCTYPE html>
<html lang="en">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>

    <title></title>

    <!-- CSS  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/drawingboard.js/0.4.6/drawingboard.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
    <style>
      #layer_result canvas {
        border: 1px solid grey;
        margin: 5px;
      }
      #layer_result > div {
        overflow-x: auto;
      }
    </style>


  </head>
  <body>

    <!-- with input that accepts one file -->
    <input id="local_file" type="file">
    <div>
      <h4 id="result_emotion"></h4>
      <h4 id="result_gender"></h4>
    </div>

    <!--
    <img id="im" src="./prayuth.png" />
    <img id="im2" src="./prayuth_sad.png" />
    <img id="im3" src="./p1.png" />
    <img id="im4" src="./p2.png" />
    <img id="im5" src="./gun.png" />
  -->
    <div id="show_img" class="image-container"></div>

    <div class="demo-containerx">
      <!--<img id="p_full" src="./angry.jpg" />-->
    </div>

    <div class="demo-container" style="float: left; width: 320px; height: 240px; display: none;">
      <video id="video" width="320" height="240" preload autoplay loop muted></video>
      <canvas id="canvas" width="320" height="240"></canvas>
    </div>

    <canvas id="canvas_face" width="64" height="64"></canvas>

    <div id="chart_container">

      <div style="width: 300px; height: 200px;">
        <canvas id="chart_emotion" class="chartjs" width="300" height="200" style="width: 300px; height: 200px;"></canvas>
      </div>

      <div style="width: 300px; height: 200px;">
        <canvas id="chart_gender" class="chartjs" width="300" height="200" style="width: 300px; height: 200px;"></canvas>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.9"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/tracking-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/data/face-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>

    <div id="debug"></div>

    <script>

      var LABEL_EMOTIONS = {0:'angry',1:'disgust',2:'fear',3:'happy', 4:'sad',5:'surprise',6:'neutral'};
      var LABEL_GENDER = {0:'woman', 1:'man'};

      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      var canvas_face = document.getElementById('canvas_face');
      var ctx_face = canvas_face.getContext('2d');


      var model_emotion;
      var model_gender;
      $(document).ready(function () {

        $("#local_file").change(function() {
            // will log a FileList object, view gifs below
            console.log(this.files);
            renderImage(this.files[0]);
            $('#result_emotion').html("&nbsp;");
            $('#result_gender').html("&nbsp;");
        });


        init = async () => {
          model_emotion = await tf.loadModel("./model/emotion/model.json");
          console.log("Model Emotion Loaded");
          model_gender = await tf.loadModel("./model/gender/model.json");
          console.log("Model Gender Loaded");

          //result = model.predict(tf.zeros([1, 28, 28, 1])).print();;

        };

        init();
        initChart();
      });

      var chart_emotion;
      var chart_gender;
      function initChart() {
        var options = {
            "responsive": true,
            "maintainAspectRatio": false,
            "scales":{
               "xAxes":[
                  {
                     "ticks":{
                        "beginAtZero":true
                     }
                  }
               ]
            }
         };
        chart_emotion = new Chart(document.getElementById("chart_emotion"), {
            type: 'horizontalBar',
            data: {
              "labels":[
                 "Angry",
                 "Disgust",
                 "Fear",
                 "Happy",
                 "Sad",
                 "Surprise",
                 "Neutral"
              ],
              "datasets":[
                 {
                    "label":"Emotion",
                    "data":[0, 0, 0, 0, 0, 0, 0],
                    "fill":false,
                    "backgroundColor":[
                       "rgba(255, 99, 132, 0.2)",
                       "rgba(255, 159, 64, 0.2)",
                       "rgba(255, 205, 86, 0.2)",
                       "rgba(75, 192, 192, 0.2)",
                       "rgba(54, 162, 235, 0.2)",
                       "rgba(153, 102, 255, 0.2)",
                       "rgba(201, 203, 207, 0.2)"
                    ],
                    "borderColor":[
                       "rgb(255, 99, 132)",
                       "rgb(255, 159, 64)",
                       "rgb(255, 205, 86)",
                       "rgb(75, 192, 192)",
                       "rgb(54, 162, 235)",
                       "rgb(153, 102, 255)",
                       "rgb(201, 203, 207)"
                    ],
                    "borderWidth":1
                 }
              ]
           },
            options: options
        });
        chart_gender = new Chart(document.getElementById("chart_gender"), {
            type: 'horizontalBar',
            data: {
              "labels":[
                 "Women",
                 "Man",
              ],
              "datasets":[
                 {
                    "label":"Gender",
                    "data":[0, 0],
                    "fill":false,
                    "backgroundColor":[
                       "rgba(255, 99, 132, 0.2)",
                       "rgba(54, 162, 235, 0.2)",
                    ],
                    "borderColor":[
                       "rgb(255, 99, 132)",
                       "rgb(54, 162, 235)",
                    ],
                    "borderWidth":1
                 }
              ]
           },
            options: options
        });
      }

      function renderImage(file) {

        // generate a new FileReader object
        var reader = new FileReader();

        // inject an image with the src url
        reader.onload = function(event) {
          the_url = event.target.result;
          var html = "<img id='input_img' src='" + the_url + "' style='max-width: 400px'  />";
          $('#show_img').html(html);
          setTimeout(function(){
            trackFace();
          }, 500);

        }

        // when the file is read it triggers the onload event above.
        reader.readAsDataURL(file);
      }

      var tracker = new tracking.ObjectTracker(['face']);
      //tracker.setStepSize(1.7);
      //tracker.setInitialScale(1);
      //tracking.track('#video', tracker, { camera: true });


      /*
      setTimeout(function(){

        console.log("Fuck");
        console.log("vwidth: " + video.videoWidth);
        console.log("vheight: " + video.videoHeight);
        $('#video, #canvas').width(240);
        $('#video, #canvas').height(320);
        canvas = document.getElementById('canvas');
        context = canvas.getContext('2d');
        video = document.getElementById('video');
      }, 2000);
      */

      tracker.on('track', function(faces) {
        context.clearRect(0, 0, canvas.width, canvas.height);
        if (faces.data.length == 0) {
          console.log("Face not found");
          return;
        }

        //plot_video(faces);
        faces.data.forEach(function(rect) {
          //console.log(rect);
          plot(rect.x, rect.y, rect.width, rect.height);
        });
      });

      function plot_video(event) {
        console.log(event);

        event.data.forEach(function(rect) {
          console.log(rect);


          // Create input canvas
          //console.log("naturalWidth: " + video.naturalWidth);
          console.log("width: " + video.width);
          console.log("height: " + video.height);
          console.log("vwidth: " + video.videoWidth);
          console.log("vheight: " + video.videoHeight);

          var ratio = video.videoWidth / video.width;
          console.log(ratio);

          startTime = performance.now();
          //ctx_face.drawImage(video, rect.x, rect.y, rect.width, rect.height, 0, 0, 64, 64);
          ctx_face.drawImage(video, rect.x*ratio, rect.y*ratio, rect.width * ratio, rect.height * ratio, 0, 0, 64, 64);
          var imageData = ctx_face.getImageData(0, 0, canvas.width, canvas.height);
          console.log(imageData);
          var data = imageData.data;
          for (var i = 0; i < data.length; i += 4) {
            var avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i]     = avg; // red
            data[i + 1] = avg; // green
            data[i + 2] = avg; // blue
          }
          ctx_face.putImageData(imageData, 0, 0);

          totalTime = performance.now() - startTime;
          debug('Plot Time: ' + Math.floor(totalTime));
          result = preprocess_input(canvas_face);

          context.clearRect(0, 0, canvas.width, canvas.height);
          context.strokeStyle = '#a64ceb';
          context.strokeRect(rect.x, rect.y, rect.width, rect.height);
          /*
          context.font = '16px Helvetica';
          context.fillStyle = "#ff0000";
          context.fillText('Gender: ' + result.gender, rect.x + rect.width + 5, rect.y + 11);
          context.fillText('Emotion: ' + result.emotion, rect.x + rect.width + 5, rect.y + 22);
          */
        });
      }


      function trackFace() {
        var img = $('#input_img');

         tracking.track('#input_img', tracker);


      }

      function preprocess_input(im) {
        startTime = performance.now();

        img = tf.fromPixels(im, 1).toFloat()
        offset = tf.scalar(255);
        x1 = tf.scalar(0.5);
        x2 = tf.scalar(2);
        normalized = img.div(offset).sub(x1).mul(x2);
        batched = normalized.reshape([1, 64, 64, 1]);

        r = model_emotion.predict(batched);
        result = r.dataSync();
        tresult = tf.tensor(result)
        label_index = tf.argMax(tresult).dataSync()[0]

        chart_emotion.data.datasets[0].data = result;
        chart_emotion.update();
        console.log(result);
        console.log(label_index)
        result_emotion = LABEL_EMOTIONS[label_index];
        console.log("Predict: " + LABEL_EMOTIONS[label_index]);

        $('#result_emotion').html("Emotion: " + LABEL_EMOTIONS[label_index]);
        totalTime = performance.now() - startTime;
        console.log('Predict Time: ' + Math.floor(totalTime));
        debug('Predict Time: ' + Math.floor(totalTime));

        r = model_gender.predict(batched);
        result = r.dataSync();
        tresult = tf.tensor(result)
        label_index = tf.argMax(tresult).dataSync()[0]

        console.log(result);
        console.log(label_index)
        console.log("Predict Gender: " + LABEL_GENDER[label_index]);
        $('#result_gender').html("Gender: " + LABEL_GENDER[label_index]);
        result_gender = LABEL_GENDER[label_index];

        chart_gender.data.datasets[0].data = result;
        chart_gender.update();

        return {'emotion': result_emotion, 'gender': result_gender};
      }

      function debug(text) {
        //$('#debug').prepend("<div>" + text + "</div>");
      }

      function plot(x, y, w, h, img) {
        startTime = performance.now();

        console.log("plot")
        console.log(x, y, w, h);
        //var img = document.getElementById('p_full');
        var img = document.getElementById('input_img');
        var rect = document.createElement('div');
        document.querySelector('#show_img').appendChild(rect);
        rect.classList.add('rect');
        rect.style.width = w + 'px';
        rect.style.height = h + 'px';
        rect.style.left = (img.offsetLeft + x) + 'px';
        rect.style.top = (img.offsetTop + y) + 'px';

        console.log("naturalWidth: " + img.naturalWidth);
        console.log("width: " + img.width);

        var ratio = img.naturalWidth / img.width;
        console.log("ratio: " + ratio);


        // Create input canvas
        canvas = document.createElement('canvas');
        ctx = canvas.getContext('2d');
        canvas.id = "tun";
        canvas.width = 64;
        canvas.height = 64;
        ctx.drawImage(img, x*ratio, y*ratio, w * ratio, h * ratio, 0, 0, 64, 64);
        document.body.appendChild(canvas)

        //Convert to Grayscaling
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        console.log(imageData);
        var data = imageData.data;
        for (var i = 0; i < data.length; i += 4) {
          var avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
          data[i]     = avg; // red
          data[i + 1] = avg; // green
          data[i + 2] = avg; // blue
        }
        ctx.putImageData(imageData, 0, 0);

        totalTime = performance.now() - startTime;
        debug('Plot Time: ' + Math.floor(totalTime));
        preprocess_input(canvas);
      };
    </script>

    <style>
     .rect {
       border: 2px solid #a64ceb;
       left: -1000px;
       position: absolute;
       top: -1000px;
     }
     #img {
       position: absolute;
       top: 50%;
       left: 50%;
       margin: -173px 0 0 -300px;
     }

     #show_img {
       position: relative;
       float: left;
     }
     video, canvas {
       /*
    margin-left: 230px;
    margin-top: 120px;
    */
    position: absolute;
  }
  #canvas_face {
    display: none;
    position: absolute;
    top: 211px;
    left: 340px;
    width: 64px;
    height: 64px;
    border: 1px solid #ff0000;
  }
  #chart_container {
    float: left;
  }
     </style>

  </body>
</html>
